{% extends 'admins/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/style5.css?v=1.0' %}">
<h3 class="text-center text-danger mt-2">ADAR AI</h3>
<div class="container mt-5">
    <div class="chat-box" id="chat-box">
        {% for chat in chats %}
            <div class="user-message m-3">
                <strong>{{ chat.user.username }}</strong> <br> {{ chat.message }}
                <button id="copy_button" class="btn btn-sm copy-button text-light" data-content="{{ chat.message }}"><i class="bi bi-clipboard"></i></button>
            </div>
            <div class="bot-response">
                <strong><i class="bi bi-robot"></i></strong><br>
                {{ chat.response|safe }}
                <button id="copy_button" class="btn btn-sm copy-button" data-content="{{ chat.response }}"><i class="bi bi-clipboard"></i></button>
            </div>
        {% endfor %}
    </div>

    <div class="commands mt-3 mb-3">
        <div class="command-box btn btn-primary rounded-pill m-1" data-command="Available rooms">Available rooms</div>
        <div class="command-box btn btn-success rounded-pill m-1" data-command="Pending bookings">Pending bookings</div>
        <div class="command-box btn btn-warning rounded-pill m-1" data-command="Total bookings">Total bookings</div>
        <div class="command-box btn btn-info rounded-pill m-1" data-command="Total revenue by room type">Total revenue by room type</div>
        <div class="command-box btn btn-danger rounded-pill m-1" data-command="Total revenue by hall type">Total revenue by hall type</div>
        <div class="command-box btn btn-secondary rounded-pill m-1" data-command="Total number of memberships">Total number of memberships</div>
        <div class="command-box btn btn-dark rounded-pill m-1" data-command="Booking trends">Booking trends</div>
        <div class="command-box btn btn-light rounded-pill m-1" data-command="Room booking trends">Room booking trends</div>
        <div class="command-box btn btn-primary rounded-pill m-1" data-command="Hall booking trends">Hall booking trends</div>
    </div>

    <div class="d-flex justify-content-center">
        <form method="post" id="chat-form">
            {% csrf_token %}
            {% for field in form %}
                <div class="mb-3">
                    {{ field|add_class:"form-control rounded w-100" }}
                    {% if field.errors %}
                        <div class="alert alert-danger mt-2">
                            {{ field.errors|first }}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
            <div class="d-flex justify-content-center">
                <button type="submit" class="btn btn-success mt-2 rounded pr-5 pl-5">Send</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Function to copy text to clipboard
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
    }

    // Function to clear clipboard content
    function clearClipboard() {
        navigator.clipboard.writeText('');
    }

    // Function to strip HTML tags from a string
    function stripHTMLTags(text) {
        let doc = new DOMParser().parseFromString(text, 'text/html');
        return doc.body.textContent || "";
    }

    // Add event listeners to copy buttons
    document.querySelectorAll('.copy-button').forEach(button => {
        let isCopied = false;  // Flag to keep track of copy state

        button.addEventListener('click', () => {
            const content = button.getAttribute('data-content');
            const strippedContent = stripHTMLTags(content);  // Strip HTML tags
            
            if (isCopied) {
                // If already copied, clear clipboard and revert button
                clearClipboard();
                button.innerHTML = '<i class="bi bi-clipboard"></i>';
            } else {
                // If not copied, copy stripped content and change button to tick
                copyToClipboard(strippedContent);
                button.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
            }

            // Toggle the copy state
            isCopied = !isCopied;
        });
    });

    // Scroll chat box to the last response
    function scrollToLastResponse() {
        const chatBox = document.getElementById('chat-box');
        const lastResponse = document.querySelector('.bot-response:last-of-type');
        if (lastResponse) {
            setTimeout(() => {
                lastResponse.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100); // delay of 100ms
        }
    }

    // Call the scrollToLastResponse function to scroll to the last response
    scrollToLastResponse();

    // Optionally, you can also observe the chat box for new messages
    const observer = new MutationObserver(() => {
        scrollToLastResponse();
    });
    observer.observe(document.getElementById('chat-box'), { childList: true });

    // Add event listeners to command boxes
    document.querySelectorAll('.command-box').forEach(box => {
        box.addEventListener('click', () => {
            const command = box.getAttribute('data-command');
            document.querySelector('textarea[name="message"]').value = command;
            document.getElementById('chat-form').submit();
        });
    });
</script>
{% endblock content %}
